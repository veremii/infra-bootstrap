# infra-bootstrap

Production-ready –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è –∑–∞—â–∏—â—ë–Ω–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞ Debian/Ubuntu —Å–µ—Ä–≤–µ—Ä–∞—Ö. –í–∫–ª—é—á–∞–µ—Ç SSH hardening, Docker Swarm, WireGuard VPN, Traefik, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

## ‚ú® –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏–∑ –∫–æ—Ä–æ–±–∫–∏**: SSH hardening, UFW firewall, fail2ban, WireGuard VPN
- **üê≥ Docker Swarm ready**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ overlay —Å–µ—Ç–µ–π –∏ —Å–µ—Ä–≤–∏—Å–æ–≤
- **üåê Edge-ready**: Traefik —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏
- **üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: Loki + Promtail + Grafana –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤
- **üè¢ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã**: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Å—è—Ç–∫–∞–º–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏
- **üì¶ Bundle deployment**: —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è
- **üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç**: –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–ª–∏ –ø–æ–ª–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (–±—É–∫–≤–∞–ª—å–Ω–æ –≤ –æ–¥–∏–Ω –∫–ª–∏–∫)

```bash
git clone https://github.com/your-org/infra-bootstrap.git
cd infra-bootstrap
./scripts/quickstart.sh  # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –°–æ–∑–¥–∞—Å—Ç .env –∏–∑ —à–∞–±–ª–æ–Ω–∞
- –û–ø—Ä–µ–¥–µ–ª–∏—Ç –ø—É–±–ª–∏—á–Ω—ã–π IP
- –°–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SSH –∫–ª—é—á–∏
- –ü—Ä–æ–≤–µ—Ä–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- –ü–æ–∫–∞–∂–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
infra-bootstrap/
‚îú‚îÄ‚îÄ Makefile                    # –û—Å–Ω–æ–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ bootstrap.sh                # –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ .env.example                # –®–∞–±–ª–æ–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ .gitignore                  # Git –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îú‚îÄ‚îÄ .pre-commit-config.yaml     # Pre-commit —Ö—É–∫–∏
‚îú‚îÄ‚îÄ CHANGELOG.md                # –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
‚îú‚îÄ‚îÄ README.md                   # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ test-local.sh               # –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ
‚îú‚îÄ‚îÄ scripts/                    # –û—Å–Ω–æ–≤–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ quickstart.sh           # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ healthcheck.sh          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã
‚îÇ   ‚îú‚îÄ‚îÄ env-selector.sh         # –í—ã–±–æ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ hostname
‚îÇ   ‚îú‚îÄ‚îÄ bundle-create.sh        # –°–æ–∑–¥–∞–Ω–∏–µ deployment bundles
‚îÇ   ‚îú‚îÄ‚îÄ lib.sh                  # –û–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ wg-new-client.sh        # –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä WG –∫–ª–∏–µ–Ω—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ wg-client-apply.sh      # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ WG –∫–æ–Ω—Ñ–∏–≥–∞
‚îÇ   ‚îú‚îÄ‚îÄ net-bootstrap.sh        # –°–æ–∑–¥–∞–Ω–∏–µ Docker —Å–µ—Ç–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ swarm-ports.sh          # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—Ç–∞–º–∏ Swarm
‚îÇ   ‚îú‚îÄ‚îÄ fail2ban-ssh.sh         # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ fail2ban
‚îÇ   ‚îú‚îÄ‚îÄ secrets-resolve.sh      # –†–∞–±–æ—Ç–∞ —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ secrets-to-swarm.sh     # –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ Swarm
‚îÇ   ‚îú‚îÄ‚îÄ service-vars.sh         # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ stack-traefik.sh        # –î–µ–ø–ª–æ–π Traefik
‚îÇ   ‚îú‚îÄ‚îÄ stack-obs.sh            # –î–µ–ø–ª–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (Loki/Grafana)
‚îÇ   ‚îî‚îÄ‚îÄ stack-portainer.sh      # –î–µ–ø–ª–æ–π Portainer
‚îÇ
‚îú‚îÄ‚îÄ envs/                       # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ–∫—Ä—É–∂–µ–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ hosts.yml               # –ú–∞–ø–ø–∏–Ω–≥ —Ö–æ—Å—Ç–æ–≤ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ README.md               # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è–º
‚îÇ   ‚îú‚îÄ‚îÄ production/             # Production –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ edge-de1.env        # –ü—Ä–∏–º–µ—Ä edge –Ω–æ–¥—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app-1.env           # –ü—Ä–∏–º–µ—Ä app –Ω–æ–¥—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ default.env         # –î–µ—Ñ–æ–ª—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ example.env         # –®–∞–±–ª–æ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ staging/                # Staging –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ all.env             # All-in-one –¥–ª—è staging
‚îÇ   ‚îî‚îÄ‚îÄ development/            # Development –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îÇ       ‚îî‚îÄ‚îÄ local.env           # –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
‚îÇ
‚îî‚îÄ‚îÄ .github/                    # GitHub –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    ‚îî‚îÄ‚îÄ workflows/
        ‚îî‚îÄ‚îÄ ci.yml              # CI/CD pipeline
```

## –¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞

1) –ü–æ–¥–≥–æ—Ç–æ–≤—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ:

```bash
cp .env.example .env
# –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π .env - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –ø–æ–º–µ—á–µ–Ω—ã [REQUIRED]
make check-env  # –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```

2) –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:

```bash
sudo make init users ssh ufw docker deploy_dir
```

3) WireGuard ‚Äî —Å–µ—Ä–≤–µ—Ä –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –Ω–æ–¥–µ:

```bash
sudo make wg-server
```

4) –°–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ WG-—Å–µ—Ä–≤–µ—Ä–µ):

```bash
sudo NAME=vps2 IP=10.88.0.12 make wg-client
# –ø–æ–ª—É—á–µ–Ω–Ω—ã–π vps2.conf ‚Äî –ø–æ–ª–æ–∂–∏—Ç—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç –≤ /etc/wireguard/wg0.conf
```

5) –ù–∞ –∫–ª–∏–µ–Ω—Ç–µ:

```bash
sudo apt-get update && sudo apt-get install -y wireguard
sudo cp vps2.conf /etc/wireguard/wg0.conf
sudo chmod 600 /etc/wireguard/wg0.conf
sudo systemctl enable --now wg-quick@wg0
```

6) Docker Swarm –∏ —Å–µ—Ä–≤–∏—Å—ã:

```bash
sudo make net-bootstrap  # —Å–æ–∑–¥–∞—Ç—å overlay-—Å–µ—Ç–∏
sudo make swarm-allow    # –æ—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç—ã —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ wg0
sudo make traefik-up     # –ø–æ–¥–Ω—è—Ç—å Traefik
sudo make logs-up        # –ø–æ–¥–Ω—è—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
sudo make portainer-up   # –ø–æ–¥–Ω—è—Ç—å Portainer (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

7) Edge-–Ω–æ–¥–∞: –æ—Ç–∫—Ä—ã—Ç—å HTTP/HTTPS:

```bash
sudo make edge-open
# –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏:
sudo make edge-close
```

8) –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:

```bash
make healthcheck  # –ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã
make status       # –∫—Ä–∞—Ç–∫–∏–π —Å—Ç–∞—Ç—É—Å
```

## üè¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏

–î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–µ—Å—è—Ç–∫–∞–º–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–±–æ—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –∏ —Å–æ–∑–¥–∞–Ω–∏—è deployment bundles.

### 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

```
envs/
‚îú‚îÄ‚îÄ hosts.yml              # –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ö–æ—Å—Ç–æ–≤ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
‚îú‚îÄ‚îÄ production/
‚îÇ   ‚îú‚îÄ‚îÄ edge-de1.env      # Edge –Ω–æ–¥–∞ –≤ –ì–µ—Ä–º–∞–Ω–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ edge-us1.env      # Edge –Ω–æ–¥–∞ –≤ –°–®–ê
‚îÇ   ‚îú‚îÄ‚îÄ app-1.env         # App —Å–µ—Ä–≤–µ—Ä 1
‚îÇ   ‚îî‚îÄ‚îÄ db-1.env          # Database —Å–µ—Ä–≤–µ—Ä
‚îú‚îÄ‚îÄ staging/
‚îÇ   ‚îî‚îÄ‚îÄ all.env           # Staging all-in-one
‚îî‚îÄ‚îÄ development/
    ‚îî‚îÄ‚îÄ local.env         # –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ bundles

#### –°–æ–∑–¥–∞–Ω–∏–µ bundle –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞:

```bash
# –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ö–æ—Å—Ç—ã
make bundle-list

# –°–æ–∑–¥–∞—Ç—å bundle –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞
make bundle-create HOST=prod-edge-de1.example.com

# –°–æ–∑–¥–∞—Ç—å bundle –¥–ª—è –≤—Å–µ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
make bundle-create ENV=staging OUTPUT=staging-bundle.tar.gz

# –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π bundle –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
./scripts/bundle-create.sh -H prod-app-1 --minimal
```

#### –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ —Ü–µ–ª–µ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ:

```bash
# 1. –ö–æ–ø–∏—Ä—É–µ–º bundle –Ω–∞ —Å–µ—Ä–≤–µ—Ä
scp bundle-prod-edge-de1.tar.gz admin@server:~/

# 2. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
ssh admin@server
tar -xzf bundle-prod-edge-de1.tar.gz
cd infra-bootstrap
./bootstrap.sh

# 3. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —É–¥–∞–ª—è–µ–º
cd .. && rm -rf infra-bootstrap bundle-*.tar.gz
```

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç hostname –∏ –∑–∞–≥—Ä—É–∑–∏—Ç –Ω—É–∂–Ω—ã–π .env
make env-select

# –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
make env-list

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–±—Ä–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
./scripts/env-selector.sh -c production/edge-de1.env

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞
./scripts/env-selector.sh -H prod-app-1.internal
```

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ hosts.yml

```yaml
hosts:
  prod-edge-de1.example.com:
    env: production
    config: production/edge-de1.env
    role: edge
    datacenter: hetzner-de
    swarm_labels:
      - "node.labels.role==edge"
      - "node.labels.dc==de"
    
  prod-app-1.internal:
    env: production
    config: production/app-1.env
    role: app
    datacenter: hetzner-de

defaults:
  env: production
  config: production/default.env
```

### 5. Workflow –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è

#### –í–∞—Ä–∏–∞–Ω—Ç 1: –° —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```bash
# –°–æ–∑–¥–∞—ë–º bundles –¥–ª—è –≤—Å–µ—Ö —Ö–æ—Å—Ç–æ–≤
for host in $(make bundle-list | grep -v "===" | grep -v "Create"); do
  make bundle-create HOST=$host
done

# –î–µ–ø–ª–æ–∏–º –Ω–∞ –≤—Å–µ —Å–µ—Ä–≤–µ—Ä–∞ (–ø—Ä–∏–º–µ—Ä —Å GNU parallel)
parallel -j 4 '
  scp bundle-{}.tar.gz admin@{}:~/ &&
  ssh admin@{} "tar -xzf bundle-{}.tar.gz && cd infra-bootstrap && ./bootstrap.sh -y"
' ::: $(ls bundle-*.tar.gz | sed 's/bundle-//;s/.tar.gz//')
```

#### –í–∞—Ä–∏–∞–Ω—Ç 2: CI/CD pipeline

```yaml
# .github/workflows/deploy.yml
deploy:
  runs-on: ubuntu-latest
  strategy:
    matrix:
      host: [prod-edge-de1, prod-app-1, prod-app-2]
  steps:
    - uses: actions/checkout@v4
    - name: Create bundle
      run: make bundle-create HOST=${{ matrix.host }}
    - name: Deploy
      run: |
        scp bundle-${{ matrix.host }}.tar.gz deploy@${{ matrix.host }}:~/
        ssh deploy@${{ matrix.host }} './deploy.sh'
```

### 6. –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
for host in prod-edge-1 prod-app-1 prod-app-2; do
  echo "=== $host ==="
  ssh admin@$host "infra-healthcheck" || true
done

# –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
make bundle-create HOST=prod-edge-1
scp bundle-prod-edge-1.tar.gz admin@prod-edge-1:~/
ssh admin@prod-edge-1 "tar -xzf bundle-*.tar.gz && cd infra-bootstrap && make env-select"
```

## –û–ø–∏—Å–∞–Ω–∏–µ —Ü–µ–ª–µ–π Makefile

### üÜï –ù–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
- **quickstart**: –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞
- **check-env**: –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- **healthcheck**: –ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã
- **net-bootstrap**: —Å–æ–∑–¥–∞—Ç—å Docker overlay-—Å–µ—Ç–∏ (edge, app, infra)
- **env-select**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–æ hostname
- **env-list**: –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ–∫—Ä—É–∂–µ–Ω–∏–π
- **bundle-create HOST=name**: —Å–æ–∑–¥–∞—Ç—å deployment bundle –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞
- **bundle-list**: –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ö–æ—Å—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è bundle

### üì¶ –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
- **init**: –±–∞–∑–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã, —Ç–∞–π–º–∑–æ–Ω–∞
- **users**: —Å–æ–∑–¥–∞—ë—Ç `ADMIN_USER` –∏ `DEPLOY_USER`, –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–ª—é—á–∏, sudo
- **ssh**: –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç SSH –Ω–∞ `SSH_PORT`, –≤—ã–∫–ª—é—á–∞–µ—Ç –ø–∞—Ä–æ–ª–∏ –∏ root
- **ufw**: –≤–∫–ª—é—á–∞–µ—Ç UFW, –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç SSH –∏ WG-–ø–æ—Ä—Ç, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ 80/443 –ø—Ä–∏ `EDGE_OPEN_HTTP=true`
- **docker**: —Å—Ç–∞–≤–∏—Ç Docker CE, –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –≥—Ä—É–ø–ø—É `docker`
- **deploy_dir**: —Å–æ–∑–¥–∞—ë—Ç `/srv/deploy` –∏ –≤—ã–¥–∞—ë—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ `DEPLOY_USER`

### üîê WireGuard VPN
- **wg-server**: –ø–æ–¥–Ω–∏–º–∞–µ—Ç WG-—Å–µ—Ä–≤–µ—Ä (`/etc/wireguard/wg0.conf`)
- **wg-client NAME=<name> IP=<10.88.0.X>**: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–æ–Ω—Ñ–∏–≥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- **wg-client-apply CONFIG=... [IF=wg0]**: –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–æ–Ω—Ñ–∏–≥ –Ω–∞ –Ω–æ–¥–µ

### üê≥ Docker Swarm
- **swarm-allow**: –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ—Ä—Ç—ã Swarm —Ç–æ–ª—å–∫–æ –Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ `wg0`
- **swarm-ports ACTION=open|close [IF=wg0]**: –æ—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç—ã Swarm –Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ

### üåê –°–µ—Ä–≤–∏—Å—ã
- **traefik-up / traefik-down**: –ø–æ–¥–Ω—è—Ç—å/—Å–Ω–µ—Å—Ç–∏ Traefik —Å—Ç–µ–∫ (edge-–Ω–æ–¥–∞, 80/443 host)
- **logs-up / logs-down**: –ø–æ–¥–Ω—è—Ç—å/—Å–Ω–µ—Å—Ç–∏ Loki+Promtail+Grafana (Grafana –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ Traefik)
- **portainer-up / portainer-down**: –ø–æ–¥–Ω—è—Ç—å/—Å–Ω–µ—Å—Ç–∏ Portainer CE (UI –¥–ª—è Docker/Swarm)

### üîß –£—Ç–∏–ª–∏—Ç—ã
- **edge-open/edge-close**: –æ—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å 80/443
- **status**: –∫—Ä–∞—Ç–∫–∏–π —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
- **show-ssh**: –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π –ø–æ—Ä—Ç SSH
- **service-vars**: –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å `CID_BE`, `CID_FE`, `CID_TRF` (–º–æ–∂–Ω–æ —Å `EXPORT=true`)
- **fail2ban-ssh ACTION=...**: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å/—É–ø—Ä–∞–≤–ª—è—Ç—å fail2ban –¥–ª—è SSH (—É—á–∏—Ç—ã–≤–∞–µ—Ç SSH_PORT)

### üîë –°–µ–∫—Ä–µ—Ç—ã
- **secrets-check SECRET=... [AGE_KEY=...] [OUT=.env]**: —Ä–∞—Å–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å/–ø—Ä–æ–≤–µ—Ä–∏—Ç—å .env –∏–∑ –æ–¥–Ω–æ–≥–æ GH-—Å–µ–∫—Ä–µ—Ç–∞ (base64 –∏–ª–∏ age+base64)
- **secrets-to-swarm ENV=.env [PREFIX=app_]**: –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞—Ä—ã –∏–∑ .env –≤ Docker Swarm secrets —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `.env`

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ [REQUIRED]
- **ADMIN_PUBKEY / DEPLOY_PUBKEY**: –ø—É–±–ª–∏—á–Ω—ã–µ SSH-–∫–ª—é—á–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞
- **WG_ENDPOINT_IP**: –ø—É–±–ª–∏—á–Ω—ã–π IP —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è WireGuard
- **TRAEFIK_ACME_EMAIL**: email –¥–ª—è Let's Encrypt —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

### –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- **SSH_PORT**: –Ω–æ–º–µ—Ä –ø–æ—Ä—Ç–∞ SSH (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1255)
- **ADMIN_USER / DEPLOY_USER**: –∏–º–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (admin, deployer)
- **TZ**: –≤—Ä–µ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞ (UTC)

### WireGuard VPN
- **WG_IF**: –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (wg0)
- **WG_PORT**: –ø–æ—Ä—Ç WireGuard (51820)
- **WG_SERVER_IP**: IP —Å–µ—Ä–≤–µ—Ä–∞ –≤ VPN —Å–µ—Ç–∏ (10.88.0.1)
- **WG_ALLOWED_IPS**: —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –ø–æ–¥—Å–µ—Ç–∏ (10.88.0.0/24)
- **WG_MTU**: —Ä–∞–∑–º–µ—Ä MTU (1420)

### –°–µ—Ä–≤–∏—Å—ã –∏ –¥–æ–º–µ–Ω—ã
- **EDGE_OPEN_HTTP**: –µ—Å–ª–∏ `true`, –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç 80/443 –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ `make ufw`
- **TRAEFIK_DASHBOARD_DOMAIN**: –¥–æ–º–µ–Ω –¥–ª—è Traefik dashboard
- **GRAFANA_DOMAIN**: –¥–æ–º–µ–Ω –¥–ª—è Grafana
- **PORTAINER_DOMAIN**: –¥–æ–º–µ–Ω –¥–ª—è Portainer

### –í–µ—Ä—Å–∏–∏ Docker –æ–±—Ä–∞–∑–æ–≤
- **TRAEFIK_VERSION**: –≤–µ—Ä—Å–∏—è Traefik (v3.1)
- **LOKI_VERSION**: –≤–µ—Ä—Å–∏—è Loki (2.9.6)
- **GRAFANA_VERSION**: –≤–µ—Ä—Å–∏—è Grafana (10.4.3)
- **PORTAINER_VERSION**: –≤–µ—Ä—Å–∏—è Portainer (2.20.3)

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

- Root-–≤—Ö–æ–¥ –ø–æ SSH –∏ –ø–∞—Ä–æ–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã.
- –î–ª—è –¥–µ–ø–ª–æ—è –¥–æ–±–∞–≤—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è sudo –¥–ª—è `deployer`, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Docker:

```bash
sudo tee /etc/sudoers.d/deployer >/dev/null <<'SUD'
Cmnd_Alias DOCKER_CMDS = /usr/bin/docker, /usr/bin/systemctl restart docker, /usr/bin/journalctl -u docker
deployer ALL=(root) NOPASSWD: DOCKER_CMDS
SUD
sudo chmod 440 /etc/sudoers.d/deployer
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

–≠—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π - **–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏**. –ü–æ—Å–ª–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –µ–≥–æ –º–æ–∂–Ω–æ –∏ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å production —Å–µ—Ä–≤–µ—Ä–∞:

```bash
# –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
cd ..
rm -rf infra-bootstrap
```

### –ß—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º:

```bash
# –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
mkdir -p ~/infra-backup
cp .env ~/infra-backup/
cp -r scripts ~/infra-backup/  # –µ—Å–ª–∏ –Ω—É–∂–Ω—ã —Å–∫—Ä–∏–ø—Ç—ã

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª–µ–∑–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –≤ —Å–∏—Å—Ç–µ–º—É
sudo cp scripts/healthcheck.sh /usr/local/bin/infra-healthcheck
sudo cp scripts/wg-new-client.sh /usr/local/bin/
sudo chmod +x /usr/local/bin/infra-healthcheck /usr/local/bin/wg-new-client

# –°—Ç–∞—Ç—É—Å —Ç–µ–∫—É—â–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker service ls > ~/infra-backup/services.txt
docker stack ls > ~/infra-backup/stacks.txt
```

### –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
git clone https://github.com/your-org/infra-bootstrap.git /tmp/infra
cd /tmp/infra
cp ~/infra-backup/.env .  # –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
make healthcheck          # –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
# –≤–Ω–µ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è...
rm -rf /tmp/infra
```

## CI / pre-commit

- GitHub Actions: –ª–∏–Ω—Ç–∏–Ω–≥ (`shellcheck`, `shfmt`) –∏ —É–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞.
- Pre-commit: –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ö—É–∫–∏ –¥–ª—è `shellcheck` –∏ `shfmt` (–Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤ —Å–∏—Å—Ç–µ–º–µ).

## –°–µ–∫—Ä–µ—Ç—ã (–µ–¥–∏–Ω—ã–π GH Secret)

- –õ–∏–º–∏—Ç GitHub Secret ‚âà 48 KB –Ω–∞ —Å–µ–∫—Ä–µ—Ç. –ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π .env –¥–æ–ø—É—Å—Ç–∏–º.
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç: base64(.env) –∏–ª–∏ base64(age-encrypted .env).
- –í CI:
  1) `make secrets-check SECRET="$ENV_B64" [AGE_KEY="$AGE_PRIVATE_KEY"] OUT=.env`
  2) `sudo make secrets-to-swarm ENV=.env PREFIX=app_`
- –ü—Ä–∏—á–∏–Ω–∞: –æ–¥–∏–Ω —Å–µ–∫—Ä–µ—Ç –Ω–∞ –æ–∫—Ä—É–∂–µ–Ω–∏–µ, –ª–µ–≥–∫–æ –ø—Ä–æ–∫–∏–Ω—É—Ç—å ‚Äú–≤—Å—ë –∏ —Å—Ä–∞–∑—É‚Äù, –Ω–æ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º (–ª–æ–∫–∞–ª—å–Ω–æ) –ª–∏–±–æ `--non-interactive` (CI).


## –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç–µ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (FE/BE) –≤ —ç—Ç–æ—Ç —ç–Ω–≤–∞–π—Ä–æ–º–µ–Ω—Ç

1) –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ

- –ü–æ–¥–Ω—è—Ç—å —Å–µ—Ç–∏: `sudo make net-bootstrap` (—Å–æ–∑–¥–∞—Å—Ç `edge`, `app(enc)`, `infra(enc)`).
- –ü–æ–¥–Ω—è—Ç—å Traefik: `sudo make traefik-up` (–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–æ–º–µ–Ω—ã/ACME/email –ø–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º).
- –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è: `make secrets-check SECRET="$ENV_B64" [AGE_KEY="$AGE_PRIVATE_KEY"] OUT=.env` ‚Üí `sudo make secrets-to-swarm ENV=.env PREFIX=app_`.

2) –°–æ–±—Ä–∞—Ç—å/–∑–∞–ø—É—à–∏—Ç—å –æ–±—Ä–∞–∑—ã –≤ —Ä–µ–µ—Å—Ç—Ä (GHCR)

- –ë—ç–∫–µ–Ω–¥/—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤ CI –∏ –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –∫–∞–∫ `ghcr.io/<org>/<app>:<tag>`.

3) –°–æ–∑–¥–∞—Ç—å `stack.yml` –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ø—Ä–∏–º–µ—Ä)

```
version: "3.9"

networks:
  app: { external: true }
  edge: { external: true }

secrets:
  app_DB_PASSWORD: { external: true }
  app_JWT_SECRET: { external: true }

services:
  backend:
    image: ghcr.io/org/backend:latest
    # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–æ–ª–∂–µ–Ω —á–∏—Ç–∞—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –∏–∑ /run/secrets/* (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)
    secrets: [app_DB_PASSWORD, app_JWT_SECRET]
    networks: [app]
    deploy:
      placement:
        constraints: ["node.labels.role==app"]
      restart_policy:
        condition: on-failure
      labels:
        # –ü—É–±–ª–∏–∫–∞—Ü–∏—è API —á–µ—Ä–µ–∑ Traefik (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø)
        - "traefik.enable=true"
        - "traefik.http.routers.api.rule=Host(`api.example.com`)"
        - "traefik.http.routers.api.entrypoints=websecure"
        - "traefik.http.routers.api.tls.certresolver=le"
        - "traefik.http.services.api.loadbalancer.server.port=3000"
        # (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –æ–±—â–∏–π perimeter-auth –∏–∑ Traefik
        # - "traefik.http.routers.api.middlewares=perimeter-auth@docker"
    # –ï—Å–ª–∏ API –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º, –¥–æ–±–∞–≤—å —Å–µ—Ç—å edge –∏ Traefik-–ª–µ–π–±–ª—ã –Ω–µ —Å—Ç–∞–≤—å.

  frontend:
    image: ghcr.io/org/frontend:latest
    networks: [edge]
    deploy:
      placement:
        constraints: ["node.labels.role==edge"]
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.front.rule=Host(`app.example.com`)"
        - "traefik.http.routers.front.entrypoints=websecure"
        - "traefik.http.routers.front.tls.certresolver=le"
        - "traefik.http.services.front.loadbalancer.server.port=80"
```

–ü–æ—è—Å–Ω–µ–Ω–∏—è

- –ü–æ–¥–∫–ª—é—á–∞–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫ `app` (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–µ—Ç—å). –ü—É–±–ª–∏—á–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø–æ–¥–∫–ª—é—á–∞–π –∫ `edge` –∏ –¥–æ–±–∞–≤–ª—è–π Traefik-–ª–µ–π–±–ª—ã.
- –°–µ–∫—Ä–µ—Ç—ã –≤ Swarm –¥–æ—Å—Ç—É–ø–Ω—ã –∫–∞–∫ —Ñ–∞–π–ª—ã `/run/secrets/<name>`. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è, —á—Ç–æ–±—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–∏—Ç–∞–ª–æ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–æ–≤, –∞ –Ω–µ –∏–∑ env.
- –†–∞–∑–º–µ—â–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑—É–π `node.labels.role` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `app`, `edge`).
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –Ω–µ –ø—É–±–ª–∏–∫—É–π –ø–æ—Ä—Ç—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤; –≤—ã—Ö–æ–¥ –Ω–∞—Ä—É–∂—É —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Traefik.

4) –î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```bash
docker stack deploy -c stack.yml app
```

5) –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ

- –ü—É—à –Ω–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞ ‚Üí `docker service update --image ghcr.io/org/backend:<tag> app_backend` (–∏–ª–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–µ–∫–∞).
- –°–µ–∫—Ä–µ—Ç—ã: –ø–µ—Ä–µ—Å–æ–∑–¥–∞–π —á–µ—Ä–µ–∑ `make secrets-to-swarm` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å—ã.

## –ñ—ë—Å—Ç–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)

–ù–∏–∂–µ ‚Äî –ª–∞–∫–æ–Ω–∏—á–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —Å –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏. –ì–¥–µ –≤–∫—É—Å–æ–≤—â–∏–Ω–∞ ‚Äî –æ—Ç–º–µ—á–µ–Ω–æ —è–≤–Ω–æ.

### Git Flow –∏ –≤–µ—Ç–∫–∏

- –û—Å–Ω–æ–≤–Ω—ã–µ –≤–µ—Ç–∫–∏: `main` (production), `develop` (staging). –í–∫—É—Å ‚Äî –º–æ–∂–Ω–æ –±–µ–∑ `develop`, –µ—Å–ª–∏ —Ä–µ–ª–∏–∑—ã —Ä–µ–¥–∫–∏–µ.
- –§–∏—á–∞-–≤–µ—Ç–∫–∏: `feat/<scope>-<short>` (–ø—Ä–∏–º–µ—Ä: `feat/api-auth`).
- –ë–∞–≥—Ñ–∏–∫—Å—ã: `fix/<scope>-<short>`.
- –†–µ–ª–∏–∑—ã/–≥–æ—Ä—è—á–∏–µ —Ñ–∏–∫—Å—ã: —Ç–µ–≥–∏ `vMAJOR.MINOR.PATCH` (semver). –í–∫—É—Å, –Ω–æ —É–¥–æ–±–Ω–æ –¥–ª—è GH Releases.
- Merge: —á–µ—Ä–µ–∑ PR, —Å–∫–≤–æ—à–∏—Ç—å –≤ `main` (–≤–∫—É—Å). –ü—Ä–∏—á–∏–Ω–∞: –∫–æ—Ä–æ—Ç–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è, –ø—Ä–æ—â–µ —á–µ–Ω–¥–∂–ª–æ–≥.

### –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤/—Å–µ—Ä–≤–∏—Å–æ–≤

- –¢—Ä–∏ –∫–ª—é—á–µ–≤—ã—Ö –∏–º–µ–Ω–∏: `traefik`, `backend`, `frontend`. –ü—Ä–∏—á–∏–Ω–∞: —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤ (`service-vars`).
- –í–∫—É—Å: –µ—Å–ª–∏ –º–æ–Ω–æ—Ä–µ–ø–æ ‚Äî –¥–æ–±–∞–≤–ª—è—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å –ø—Ä–æ–µ–∫—Ç–∞: `app-backend`, `app-frontend`.

### –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

- –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π: `YYYYMMDDHHMM__short_slug.sql` (–∏–ª–∏ –≤ —Ä–∞–º–∫–∞—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏–π). –ü—Ä–∏—á–∏–Ω–∞: —É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω–æ—Å—Ç—å –∏ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å.
- –û–¥–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è ‚Äî –æ–¥–Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∞—è —Å–º–µ–Ω–∞ —Å—Ö–µ–º—ã. –ë–µ–∑ ‚Äú–º—É–ª—å—Ç–∏–º–∏–≥—Ä–∞—Ü–∏–π‚Äù. –ü—Ä–∏—á–∏–Ω–∞: —Ç—Ä–µ–π—Å–∞–±–∏–ª–∏—Ç–∏.
- –í–∫—É—Å: —Ö—Ä–∞–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ —Ä—è–¥–æ–º —Å —Å–µ—Ä–≤–∏—Å–æ–º (–º–æ–Ω–æ—Ä–µ–ø–æ) vs –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä–µ–ø–æ ‚Äî –≤—ã–±–∏—Ä–∞–µ–º —Ä—è–¥–æ–º —Å —Å–µ—Ä–≤–∏—Å–æ–º.

### Redis / –∫—ç—à

- –ü—Ä–µ—Ñ–∏–∫—Å –∫–ª—é—á–µ–π: `<app>:<env>:<domain>:<key>`. –ü—Ä–∏—á–∏–Ω–∞: –∏–∑–æ–ª—è—Ü–∏—è —Å—Ä–µ–¥ –∏ –∫–æ–ª–ª–∏–∑–∏–π.

### CI/CD –ø—Ä–∏–Ω—Ü–∏–ø—ã

- Build ‚Äî –≤—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞—ë—Ç –æ–±—Ä–∞–∑ —Å —Ç–µ–≥–æ–º `ghcr.io/<org>/<app>:<sha>` –∏ `:latest` –Ω–∞ `main` (–≤–∫—É—Å).
- Deploy ‚Äî —á–µ—Ä–µ–∑ `docker stack deploy` —Å –≤–Ω–µ—à–Ω–∏–º `stack.yml`. –ü—Ä–∏—á–∏–Ω–∞: –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ—Å—Ç—å, –æ—Ç–∫–∞—Ç –ø–æ —Ñ–∞–π–ª—É.
- –°–µ–∫—Ä–µ—Ç—ã ‚Äî —Ç–æ–ª—å–∫–æ `docker secret`/`env from secrets` –≤ CI. –ù–∏–∫–æ–≥–¥–∞ –≤ `.env` –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- SSH ‚Äî —Ç–æ–ª—å–∫–æ –∫–ª—é—á–∏, –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ä—Ç, root-login off (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Ç–∞—Ä–≥–µ—Ç–∞–º–∏).
- Swarm —Ç—Ä–∞—Ñ–∏–∫ ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ `wg0` (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Å–∫—Ä–∏–ø—Ç–æ–º/—Ç–∞—Ä–≥–µ—Ç–æ–º).
- –õ–æ–≥–∏ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω—ã (Loki/Promtail), UI ‚Äî Grafana; —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ ‚Äî Portainer.

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

**Production-ready: 9/10**

–ß—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å:
- ‚úÖ –ü–æ–ª–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π –∏ —Å–µ—Ä–≤–µ—Ä–æ–≤
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏–∑ –∫–æ—Ä–æ–±–∫–∏ (SSH hardening, VPN, firewall)
- ‚úÖ Docker Swarm —Å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Å–µ—Ç—è–º–∏
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏
- ‚úÖ –ü—Ä–æ—Å—Ç–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ deployment bundles
- ‚úÖ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ CI/CD ready —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏

–ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å:
- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É Kubernetes –∫–∞–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã Swarm
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ–±–ª–∞—á–Ω—ã–º–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ (Terraform)
- Web UI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–∫ —Ö–æ—Ç–∏—Ç–µ!

## ü§ù Contributing

Pull requests –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è! –î–ª—è –±–æ–ª—å—à–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ issue.

---

**Made with ‚ù§Ô∏è for DevOps engineers who value their time**

